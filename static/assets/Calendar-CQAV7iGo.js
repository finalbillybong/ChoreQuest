import{a as Ne,u as ve,c as Se,d as we,r as a,b as y,j as e,C as ie,e as L,X as Ce,i as le}from"./index-vxLSLVNH.js";import{t as K}from"./questThemeText-BScvH9fI.js";import{M as ce}from"./Modal-CnoYkwco.js";import{C as ke}from"./chevron-left-njPK6pRP.js";import{C as Te}from"./chevron-right-B-OSHa_L.js";import{T as De}from"./trash-2-CGv3m0e-.js";import{A as _e,S as ze}from"./slash-CXlk2LZM.js";import{C as oe}from"./clock-BtD0wgfS.js";import"./index-Df9HbSv_.js";import"./proxy-drdOBBFt.js";function M(d){return d.toISOString().slice(0,10)}function o(d,l){const x=new Date(d+"T00:00:00");return x.setDate(x.getDate()+l),x.toISOString().slice(0,10)}const Oe=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function Re(d,l){const x=new Date().toISOString().slice(0,10);return d.status==="verified"?{border:"border-emerald",bg:"bg-emerald/10",icon:e.jsx(le,{size:16,className:"text-emerald"})}:d.status==="completed"?{border:"border-emerald",bg:"bg-emerald/5",icon:e.jsx(le,{size:16,className:"text-emerald/60"})}:d.status==="skipped"?{border:"border-border",bg:"bg-navy-light/50",icon:e.jsx(ze,{size:16,className:"text-muted"}),textClass:"line-through text-muted"}:l<x?{border:"border-crimson",bg:"bg-crimson/5",icon:e.jsx(oe,{size:16,className:"text-crimson"})}:{border:"border-border",bg:"",icon:e.jsx(oe,{size:16,className:"text-muted"})}}function Qe(){var se,ae,re;const d=Ne(),{user:l}=ve(),{chore_trading_enabled:x}=Se(),{colorTheme:O}=we(),j=(l==null?void 0:l.role)==="kid",[i,R]=a.useState(()=>M(new Date)),[P,de]=a.useState({}),[E,F]=a.useState(!0),[$,v]=a.useState(""),[me,S]=a.useState(!1),[h,ue]=a.useState(null),[I,Q]=a.useState([]),[w,W]=a.useState(""),[H,J]=a.useState(!1),[U,C]=a.useState(""),[X,Y]=a.useState(null),[r,k]=a.useState(null),[B,G]=a.useState(!1),[V,Z]=a.useState(""),b=a.useCallback(async()=>{var t,u,n;F(!0),v("");try{const T=new Date(i+"T00:00:00").getDay(),q=T===0?-6:1-T,p=o(i,q),D=await y(`/api/calendar?week_start=${p}`),s={};for(let m=0;m<7;m++){const c=o(i,m);s[c]=((t=D.days)==null?void 0:t[c])||[]}const f=o(p,7),_=o(i,6),z=o(p,6);if(_>z)try{const m=await y(`/api/calendar?week_start=${f}`);for(let c=0;c<7;c++){const N=o(i,c);!((u=s[N])!=null&&u.length)&&((n=m.days)!=null&&n[N])&&(s[N]=m.days[N])}}catch{}de(s)}catch(g){v(g.message||"Failed to load calendar")}finally{F(!1)}},[i]);a.useEffect(()=>{b()},[b]),a.useEffect(()=>{const t=()=>{b()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[b]);const xe=()=>R(o(i,-7)),he=()=>R(o(i,7)),be=()=>R(M(new Date)),ge=async t=>{ue(t),C(""),W(""),S(!0);try{const n=(await y("/api/stats/kids")||[]).filter(g=>g.id!==l.id);Q(n)}catch{Q([])}},pe=async()=>{if(!w){C("Select a hero to trade with");return}J(!0),C("");try{await y("/api/calendar/trade",{method:"POST",body:{assignment_id:h.id,target_user_id:w}}),S(!1),b()}catch(t){C(t.message||"Trade failed")}finally{J(!1)}},A=async(t,u=!1)=>{Y(t),k(null);try{await y(`/api/calendar/assignments/${t}${u?"?all_future=true":""}`,{method:"DELETE"}),b()}catch(n){v(n.message||"Failed to remove quest")}finally{Y(null)}},fe=async()=>{G(!0),Z("");try{const t=await y("/api/chores/cleanup-all-stale",{method:"POST"});Z(t.message||"Cleanup complete"),b()}catch(t){v(t.message||"Cleanup failed")}finally{G(!1)}},ye=o(i,6),ee=M(new Date),je=i===ee,te=t=>new Date(t+"T00:00:00").toLocaleDateString(void 0,{month:"short",day:"numeric"});return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Quest Calendar"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:xe,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Previous week",children:e.jsx(ke,{size:20})}),e.jsxs("span",{className:"text-cream text-sm min-w-[140px] sm:min-w-[180px] text-center",children:[te(i)," â€“ ",te(ye)]}),e.jsx("button",{onClick:he,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Next 7 days",children:e.jsx(Te,{size:20})})]}),!je&&e.jsx("button",{onClick:be,className:"game-btn game-btn-blue",children:"Today"}),!j&&e.jsxs("button",{onClick:fe,disabled:B,className:"game-btn game-btn-red flex items-center gap-1",title:"Remove all overdue pending quests and reset exclusions",children:[B?e.jsx(L,{size:14,className:"animate-spin"}):e.jsx(De,{size:14}),"Clean Up"]})]})]}),V&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-emerald/40 bg-emerald/10 text-emerald text-sm text-center",children:V}),$&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:$}),E&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(L,{size:32,className:"text-sky animate-spin"})}),!E&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:Array.from({length:7},(t,u)=>{const n=o(i,u),g=new Date(n+"T00:00:00"),T=Oe[g.getDay()],q=n===ee,p=P[n]||[],D=j?p.filter(s=>s.user_id===(l==null?void 0:l.id)):p;return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:`text-center py-2 px-1 rounded-t-md border-b-2 ${q?"bg-sky/10 border-sky text-sky":"bg-surface-raised/30 border-border text-muted"}`,children:[e.jsx("div",{className:"text-xs font-bold tracking-wider",children:T}),e.jsx("div",{className:"text-sm mt-1",children:new Date(n+"T00:00:00").getDate()})]}),e.jsxs("div",{className:"space-y-2 mt-2 min-h-[80px]",children:[D.length===0&&e.jsx("p",{className:"text-muted text-xs text-center py-4",children:"No quests"}),D.map(s=>{var _,z,m;const f=Re(s,n);return e.jsxs("div",{className:`game-panel !border-2 ${f.border} ${f.bg} p-2 cursor-pointer hover:brightness-110 transition-all`,onClick:()=>d(`/chores/${s.chore_id||s.id}`),children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[f.icon,e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm leading-tight truncate ${f.textClass||"text-cream"}`,children:K(((_=s.chore)==null?void 0:_.title)||s.chore_title||"Quest",O)}),!j&&(((z=s.user)==null?void 0:z.display_name)||s.assigned_to_name)&&e.jsx("p",{className:"text-xs text-purple font-medium mt-0.5 truncate",children:((m=s.user)==null?void 0:m.display_name)||s.assigned_to_name})]})]}),j&&x&&s.status==="pending"&&e.jsxs("button",{onClick:c=>{c.stopPropagation(),ge(s)},className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-sky hover:text-sky/80 transition-colors",children:[e.jsx(_e,{size:12}),"Trade"]}),!j&&s.status==="pending"&&e.jsxs("button",{onClick:c=>{var ne;c.stopPropagation(),((ne=s.chore)==null?void 0:ne.recurrence)&&s.chore.recurrence!=="once"?k(s):A(s.id)},disabled:X===s.id,className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-crimson hover:text-crimson/80 transition-colors",children:[X===s.id?e.jsx(L,{size:12,className:"animate-spin"}):e.jsx(Ce,{size:12}),"Remove"]})]},s.id)})]})]},n)})}),!E&&!$&&Object.values(P).every(t=>t.length===0)&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(ie,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No quests scheduled this week"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"The quest board is empty. Time to plan new adventures!"})]}),e.jsx(ce,{isOpen:me,onClose:()=>S(!1),title:"Propose a Trade",actions:[{label:"Cancel",onClick:()=>S(!1),className:"game-btn game-btn-red"},{label:H?"Sending...":"Send Trade",onClick:pe,className:"game-btn game-btn-blue",disabled:H||!w}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Trade"," ",e.jsx("span",{className:"text-cream font-bold",children:K(((se=h==null?void 0:h.chore)==null?void 0:se.title)||(h==null?void 0:h.chore_title)||"Quest",O)})," ","with another hero:"]}),U&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:U}),I.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No other heroes found in your party."}):e.jsx("div",{className:"space-y-2",children:I.map(t=>e.jsx("button",{onClick:()=>W(t.id),className:`w-full text-left p-3 rounded border-2 transition-colors ${w===t.id?"border-sky bg-sky/10 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e.jsx("span",{className:"text-sm",children:t.display_name||t.username})},t.id))})]})}),e.jsx(ce,{isOpen:!!r,onClose:()=>k(null),title:"Remove Recurring Quest",actions:[{label:"Cancel",onClick:()=>k(null),className:"game-btn game-btn-blue"},{label:"Just This One",onClick:()=>A(r==null?void 0:r.id,!1),className:"game-btn game-btn-red"},{label:"All Future",onClick:()=>A(r==null?void 0:r.id,!0),className:"game-btn game-btn-red"}],children:e.jsxs("p",{className:"text-muted text-sm",children:[e.jsx("span",{className:"text-cream font-bold",children:K(((ae=r==null?void 0:r.chore)==null?void 0:ae.title)||"Quest",O)})," ","is a recurring quest",(re=r==null?void 0:r.user)!=null&&re.display_name?` for ${r.user.display_name}`:"",". Remove just this one instance, or all future pending instances for this kid?"]})})]})}export{Qe as default};
