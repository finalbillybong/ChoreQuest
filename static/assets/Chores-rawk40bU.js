import{u as Ee,d as De,a as Pe,r,c as d,j as s,S as $,b as Te}from"./index-CozlsxUV.js";import{t as Ae,a as ze}from"./questThemeText-BamaNLq7.js";import{M as ie}from"./Modal-5eArh6zT.js";import{E as Fe,a as Oe}from"./eye-oMsOfHD_.js";import{P as le}from"./plus-DCQcrPYn.js";import{F as Le,S as $e,B as Re}from"./search-CWlQGPBP.js";import{P as Me}from"./pencil-BzjIGeXe.js";import{T as Qe}from"./trash-2-WzPehisX.js";import{C as re}from"./circle-check-BZUga6V9.js";import{C as R}from"./camera-_YbO_UGt.js";import{L as Ie}from"./loader-circle-iSei1Z8b.js";import{R as Ke}from"./refresh-cw-sQpMzEO5.js";import"./index-qJO88N8d.js";import"./proxy-ifYGSNcC.js";const ne=[{value:"easy",label:"Easy",level:1},{value:"medium",label:"Medium",level:2},{value:"hard",label:"Hard",level:3},{value:"expert",label:"Expert",level:4}],Ue={easy:1,medium:2,hard:3,expert:4},Be=[{value:"once",label:"One-time"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"custom",label:"Custom Days"}],de=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],oe={cleaning:"bg-sky/20 text-sky border-sky/40",cooking:"bg-gold/20 text-gold border-gold/40",outdoor:"bg-emerald/20 text-emerald border-emerald/40",homework:"bg-purple/20 text-purple border-purple/40",pet_care:"bg-crimson/20 text-crimson border-crimson/40",laundry:"bg-sky/20 text-sky border-sky/40",errands:"bg-gold/20 text-gold border-gold/40",default:"bg-cream/10 text-muted border-border"},N="bg-navy-light border-2 border-border text-cream p-2 rounded text-sm focus:border-sky focus:outline-none transition-colors";function Xe({level:i}){const n=typeof i=="string"?Ue[i]||1:i||1;return s.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4].map(o=>s.jsx(Te,{size:14,className:o<=n?"text-gold fill-gold":"text-muted"},o))})}function Ye({category:i}){const n=typeof i=="object"?i==null?void 0:i.name:i,o=oe[n==null?void 0:n.toLowerCase()]||oe.default;return s.jsx("span",{className:`inline-block px-2 py-0.5 rounded-full text-xs border ${o} capitalize`,children:n||"General"})}function He({recurrence:i,customDays:n}){return!i||i==="once"?null:s.jsxs("div",{className:"flex items-center gap-1 text-muted text-xs",children:[s.jsx(Ke,{size:12}),s.jsx("span",{className:"capitalize",children:i}),i==="custom"&&(n==null?void 0:n.length)>0&&s.jsxs("span",{className:"text-muted",children:["(",n.map(o=>de[o]||o).join(", "),")"]})]})}const ce={title:"",description:"",points:10,difficulty:"easy",category_id:"",recurrence:"once",custom_days:[],requires_photo:!1,assigned_user_ids:[]};function We(){const i=new Date,n=i.getDay(),o=n===0?-6:1-n,_=new Date(i);return _.setDate(i.getDate()+o),_.toISOString().slice(0,10)}function Ge(){return new Date().toISOString().slice(0,10)}function ms(){var te;const{user:i,updateUser:n}=Ee(),{colorTheme:o}=De(),_=Pe(),g=(i==null?void 0:i.role)==="parent"||(i==null?void 0:i.role)==="admin",m=(i==null?void 0:i.role)==="kid",[h,me]=r.useState([]),[M,ue]=r.useState([]),[Q,I]=r.useState([]),[xe,pe]=r.useState([]),[fe,ge]=r.useState(!0),[K,w]=r.useState(""),[D,he]=r.useState(""),[P,be]=r.useState(""),[k,ye]=r.useState(""),[T,je]=r.useState(!1),[U,A]=r.useState(!1),[C,z]=r.useState(null),[l,b]=r.useState({...ce}),[B,u]=r.useState(""),[X,F]=r.useState(!1),[y,S]=r.useState(null),[Y,H]=r.useState(!1),[ve,W]=r.useState(null),[x,G]=r.useState({}),j=r.useCallback(async()=>{try{w("");const e=await d("/api/chores");me(Array.isArray(e)?e:e.chores||e.items||[])}catch(e){w(e.message||"Failed to load quests from the guild board.")}},[]),q=r.useCallback(async()=>{if(m)try{const e=We(),t=Ge(),a=await d(`/api/calendar?week_start=${e}`),c=a.days&&a.days[t]||[];pe(c)}catch{}},[m]),V=r.useCallback(async()=>{try{const e=await d("/api/chores/categories");ue(Array.isArray(e)?e:e.categories||[])}catch{}},[]),J=r.useCallback(async()=>{if(g)try{const e=await d("/api/stats/family");I(Array.isArray(e)?e:[])}catch{try{const e=await d("/api/admin/users"),t=Array.isArray(e)?e:e.users||[];I(t.filter(a=>a.role==="kid"))}catch{}}},[g]),O=r.useCallback(async()=>{await Promise.all([j(),q(),V(),J()])},[j,q,V,J]);r.useEffect(()=>{O().finally(()=>ge(!1))},[O]),r.useEffect(()=>{const e=()=>{j(),q()};return window.addEventListener("ws:message",e),()=>window.removeEventListener("ws:message",e)},[j,q]);const Ne=async e=>{const t=e.id;if(!(e.requires_photo&&!x[t])){W(t);try{if(e.requires_photo&&x[t]){const a=new FormData;a.append("file",x[t]),await d(`/api/chores/${t}/complete`,{method:"POST",body:a})}else await d(`/api/chores/${t}/complete`,{method:"POST"});e.points&&i&&n({points_balance:i.points_balance+e.points}),G(a=>{const c={...a};return delete c[t],c}),await O()}catch(a){w(a.message||"Failed to complete quest")}finally{W(null)}}},E={};if(m)for(const e of xe){const t=e.chore_id||((te=e.chore)==null?void 0:te.id);t&&(E[t]=e.status)}const Z=h.filter(e=>{var t,a,c;if(D&&((t=e.category)==null?void 0:t.name)!==D||P&&e.difficulty!==P||k&&!((a=e.title)!=null&&a.toLowerCase().includes(k.toLowerCase()))&&!((c=e.description)!=null&&c.toLowerCase().includes(k.toLowerCase())))return!1;if(m&&!T){const v=E[e.id];if(v==="completed"||v==="verified")return!1}return!0}),ee=m?Object.values(E).filter(e=>e==="completed"||e==="verified").length:0,se=()=>{z(null),b({...ce}),u(""),A(!0)},Ce=e=>{z(e),b({title:e.title||"",description:e.description||"",points:e.points||10,difficulty:e.difficulty||"easy",category_id:e.category_id?String(e.category_id):"",recurrence:e.recurrence||"once",custom_days:e.custom_days||[],requires_photo:e.requires_photo||!1,assigned_user_ids:e.assigned_user_ids||e.assigned_kids||e.assigned_to||[]}),u(""),A(!0)},L=()=>{A(!1),z(null),u("")},p=(e,t)=>{b(a=>({...a,[e]:t}))},_e=e=>{b(t=>({...t,custom_days:t.custom_days.includes(e)?t.custom_days.filter(a=>a!==e):[...t.custom_days,e]}))},we=e=>{b(t=>({...t,assigned_user_ids:t.assigned_user_ids.includes(e)?t.assigned_user_ids.filter(a=>a!==e):[...t.assigned_user_ids,e]}))},ke=async()=>{if(!l.title.trim()){u("Every quest needs a name, adventurer!");return}if(l.points<1){u("The reward must be at least 1 XP.");return}F(!0),u("");const e={title:l.title.trim(),description:l.description.trim()||null,points:Number(l.points),difficulty:l.difficulty,category_id:l.category_id?Number(l.category_id):void 0,recurrence:l.recurrence,requires_photo:l.requires_photo,assigned_user_ids:l.assigned_user_ids.length>0?l.assigned_user_ids:[]};if(!e.category_id){u("Please select a category for this quest."),F(!1);return}l.recurrence==="custom"&&(e.custom_days=l.custom_days);try{C?await d(`/api/chores/${C.id}`,{method:"PUT",body:e}):await d("/api/chores",{method:"POST",body:e}),L(),await j()}catch(t){u(t.message||"The quest scroll could not be saved.")}finally{F(!1)}},Se=async()=>{if(y){H(!0);try{await d(`/api/chores/${y.id}`,{method:"DELETE"}),S(null),await j()}catch(e){w(e.message||"Failed to remove the quest.")}finally{H(!1)}}};return fe?s.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[s.jsx($,{size:48,className:"text-sky animate-pulse"}),s.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"Loading quests from the guild board..."})]}):s.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx($,{size:28,className:"text-sky"}),s.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:g?"Quest Management":"My Quests"})]}),s.jsxs("div",{className:"flex items-center gap-3",children:[m&&ee>0&&s.jsxs("button",{onClick:()=>je(e=>!e),className:"flex items-center gap-1.5 text-muted hover:text-cream text-sm transition-colors",children:[T?s.jsx(Fe,{size:16}):s.jsx(Oe,{size:16}),T?"Hide":"Show"," completed (",ee,")"]}),g&&s.jsxs("button",{onClick:se,className:"game-btn game-btn-blue flex items-center gap-2",children:[s.jsx(le,{size:16}),"Create Quest"]})]})]}),K&&s.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:K}),s.jsx("div",{className:"game-panel p-4",children:s.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-3",children:[s.jsxs("div",{className:"flex items-center gap-2 text-muted",children:[s.jsx(Le,{size:16}),s.jsx("span",{className:"text-sm",children:"Filters:"})]}),s.jsxs("div",{className:"relative flex-1 min-w-0",children:[s.jsx($e,{size:16,className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted"}),s.jsx("input",{type:"text",placeholder:"Search quests...",value:k,onChange:e=>ye(e.target.value),className:"field-input pl-9 py-2"})]}),s.jsxs("select",{value:D,onChange:e=>he(e.target.value),className:N,children:[s.jsx("option",{value:"",children:"All Categories"}),M.map(e=>s.jsx("option",{value:e.name,children:e.name},e.id))]}),s.jsxs("select",{value:P,onChange:e=>be(e.target.value),className:N,children:[s.jsx("option",{value:"",children:"All Difficulties"}),ne.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))]})]})}),Z.length===0?s.jsxs("div",{className:"game-panel p-10 text-center",children:[s.jsx($,{size:40,className:"mx-auto text-muted mb-4"}),s.jsx("p",{className:"text-muted text-sm",children:h.length===0?"The quest board is empty. No adventures await... yet!":"No quests match your search. Try adjusting the filters."}),g&&h.length===0&&s.jsxs("button",{onClick:se,className:"game-btn game-btn-blue mt-4 inline-flex items-center gap-2",children:[s.jsx(le,{size:16}),"Post First Quest"]})]}):s.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:Z.map(e=>{const t=m?E[e.id]:null,a=t==="completed"||t==="verified",c=m&&(t==="pending"||t==="assigned"),v=ve===e.id;return s.jsxs("div",{className:`game-panel p-4 flex flex-col gap-3 cursor-pointer hover:border-sky/40 transition-colors ${a?"opacity-50":""}`,onClick:()=>_(`/chores/${e.id}`),children:[s.jsxs("div",{className:"flex items-start justify-between gap-2",children:[s.jsx("h3",{className:"text-cream text-lg font-bold leading-relaxed flex-1",children:Ae(e.title,o)}),g&&s.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[s.jsx("button",{onClick:f=>{f.stopPropagation(),Ce(e)},className:"p-1.5 rounded hover:bg-surface-raised transition-colors text-muted hover:text-sky","aria-label":"Edit quest",children:s.jsx(Me,{size:14})}),s.jsx("button",{onClick:f=>{f.stopPropagation(),S(e)},className:"p-1.5 rounded hover:bg-surface-raised transition-colors text-muted hover:text-crimson","aria-label":"Delete quest",children:s.jsx(Qe,{size:14})})]}),a&&s.jsx(re,{size:18,className:"text-emerald flex-shrink-0"})]}),e.description&&s.jsx("p",{className:"text-muted text-sm line-clamp-2",children:ze(e.title,e.description,o)}),s.jsxs("div",{className:"flex items-center flex-wrap gap-2 mt-auto",children:[s.jsxs("span",{className:"flex items-center gap-1 text-gold font-bold text-sm",children:[s.jsx("span",{className:"text-lg",children:"â˜…"}),e.points," XP"]}),s.jsx(Xe,{level:e.difficulty||1})]}),s.jsxs("div",{className:"flex items-center flex-wrap gap-2",children:[s.jsx(Ye,{category:e.category}),s.jsx(He,{recurrence:e.recurrence,customDays:e.custom_days}),e.requires_photo&&s.jsxs("span",{className:"flex items-center gap-1 text-muted text-xs",children:[s.jsx(R,{size:12}),"Photo"]})]}),c&&s.jsxs("div",{className:"mt-1 space-y-2",onClick:f=>f.stopPropagation(),children:[e.requires_photo&&s.jsxs("label",{className:"inline-flex items-center gap-1.5 text-xs text-muted cursor-pointer hover:text-cream transition-colors bg-surface-raised px-3 py-1.5 rounded-lg border border-border",children:[s.jsx(R,{size:14}),s.jsx("span",{children:x[e.id]?x[e.id].name:"Attach proof photo"}),s.jsx("input",{type:"file",accept:"image/*",className:"hidden",onChange:f=>G(qe=>{var ae;return{...qe,[e.id]:((ae=f.target.files)==null?void 0:ae[0])||null}})})]}),s.jsx("button",{onClick:()=>Ne(e),disabled:v||e.requires_photo&&!x[e.id],className:`game-btn game-btn-blue w-full flex items-center justify-center gap-2 ${v?"opacity-60 cursor-wait":""} ${e.requires_photo&&!x[e.id]?"opacity-40 cursor-not-allowed":""}`,children:v?s.jsxs(s.Fragment,{children:[s.jsx(Ie,{size:14,className:"animate-spin"}),"Completing..."]}):s.jsxs(s.Fragment,{children:[s.jsx(re,{size:14}),"Complete Quest"]})})]})]},e.id)})}),s.jsx(ie,{isOpen:U,onClose:L,title:C?"Edit Quest Scroll":"New Quest Scroll",actions:[{label:"Cancel",onClick:L,className:"game-btn game-btn-blue"},{label:X?"Saving...":C?"Update Quest":"Create Quest",onClick:ke,className:"game-btn game-btn-gold",disabled:X}],children:s.jsxs("div",{className:"space-y-4",children:[B&&s.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:B}),!C&&h.length>0&&s.jsxs("div",{children:[s.jsxs("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide flex items-center gap-1.5",children:[s.jsx(Re,{size:14}),"Start from existing quest"]}),s.jsxs("select",{defaultValue:"",onChange:e=>{const t=e.target.value;if(!t)return;const a=h.find(c=>String(c.id)===t);a&&b({title:a.title||"",description:a.description||"",points:a.points||10,difficulty:a.difficulty||"easy",category_id:a.category_id?String(a.category_id):"",recurrence:a.recurrence||"once",custom_days:a.custom_days||[],requires_photo:a.requires_photo||!1,assigned_user_ids:[]})},className:`${N} w-full p-3`,children:[s.jsx("option",{value:"",children:"Create from scratch..."}),h.map(e=>s.jsxs("option",{value:String(e.id),children:[e.title," (",e.points," XP, ",e.difficulty,")"]},e.id))]},`tpl-${U}`),s.jsx("p",{className:"text-muted text-xs mt-1",children:"Pick a quest to pre-fill the form, then customise as needed."})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Quest Name"}),s.jsx("input",{type:"text",value:l.title,onChange:e=>p("title",e.target.value),placeholder:"Defeat the Dust Bunnies",className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Description"}),s.jsx("textarea",{value:l.description,onChange:e=>p("description",e.target.value),placeholder:"Describe the quest details...",rows:3,className:"field-input resize-none"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"XP Reward"}),s.jsx("input",{type:"number",min:1,value:l.points,onChange:e=>p("points",e.target.value),className:"field-input"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Difficulty"}),s.jsx("select",{value:l.difficulty,onChange:e=>p("difficulty",e.target.value),className:`${N} w-full p-3`,children:ne.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Category"}),s.jsxs("select",{value:l.category_id,onChange:e=>p("category_id",e.target.value),className:`${N} w-full p-3`,children:[s.jsx("option",{value:"",children:"Select category..."}),M.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Recurrence"}),s.jsx("select",{value:l.recurrence,onChange:e=>p("recurrence",e.target.value),className:`${N} w-full p-3`,children:Be.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]}),l.recurrence==="custom"&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-2 tracking-wide",children:"Quest Days"}),s.jsx("div",{className:"flex flex-wrap gap-2",children:de.map((e,t)=>s.jsx("button",{type:"button",onClick:()=>_e(t),className:`px-3 py-1.5 rounded border-2 text-sm transition-colors ${l.custom_days.includes(t)?"border-sky bg-sky/20 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e},e))})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("label",{className:"text-cream text-sm font-medium tracking-wide flex items-center gap-2",children:[s.jsx(R,{size:14}),"Requires Photo Proof"]}),s.jsx("button",{type:"button",onClick:()=>p("requires_photo",!l.requires_photo),className:`relative w-12 h-6 rounded-full border-2 transition-colors ${l.requires_photo?"bg-sky/20 border-sky":"bg-navy-light border-border"}`,children:s.jsx("div",{className:`absolute top-0.5 w-4 h-4 rounded-full transition-all ${l.requires_photo?"left-6 bg-sky":"left-0.5 bg-muted"}`})})]}),Q.length>0&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-cream text-sm font-medium mb-2 tracking-wide",children:"Assign to Heroes"}),s.jsx("div",{className:"space-y-2",children:Q.map(e=>s.jsxs("label",{className:"flex items-center gap-3 cursor-pointer p-2 rounded hover:bg-surface-raised/50 transition-colors",children:[s.jsx("input",{type:"checkbox",checked:l.assigned_user_ids.includes(e.id),onChange:()=>we(e.id),className:"w-4 h-4 accent-sky"}),s.jsx("span",{className:"text-cream text-sm",children:e.display_name||e.username})]},e.id))})]})]})}),s.jsx(ie,{isOpen:!!y,onClose:()=>S(null),title:"Abandon Quest?",actions:[{label:"Keep Quest",onClick:()=>S(null),className:"game-btn game-btn-blue"},{label:Y?"Removing...":"Remove Quest",onClick:Se,className:"game-btn game-btn-red",disabled:Y}],children:s.jsxs("p",{className:"text-muted",children:["Are you sure you want to remove the quest"," ",s.jsxs("span",{className:"text-cream text-lg font-bold",children:['"',y==null?void 0:y.title,'"']}),"? This action cannot be undone. All associated records will be archived."]})})]})}export{ms as default};
