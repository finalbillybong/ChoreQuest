import{a as Q,u as Z,r as a,c as x,j as e,G as ee,e as te,P as se}from"./index-CozlsxUV.js";import{M}from"./Modal-5eArh6zT.js";import{S as $,C as k}from"./shopping-bag-BrscFnAk.js";import{P as A}from"./plus-DCQcrPYn.js";import{P as ae}from"./pencil-BzjIGeXe.js";import{T as ie}from"./trash-2-WzPehisX.js";import"./index-qJO88N8d.js";import"./proxy-ifYGSNcC.js";const F={title:"",description:"",point_cost:50,icon:"",stock:""};function ue(){const X=Q(),{user:s,updateUser:D}=Z(),h=(s==null?void 0:s.role)==="parent"||(s==null?void 0:s.role)==="admin",C=(s==null?void 0:s.role)==="kid",[S,I]=a.useState([]),[U,B]=a.useState(!0),[w,g]=a.useState(""),[G,f]=a.useState(!1),[u,b]=a.useState(null),[n,j]=a.useState({...F}),[T,o]=a.useState(""),[E,P]=a.useState(!1),[r,p]=a.useState(null),[R,_]=a.useState(!1),[N,z]=a.useState(null),[l,v]=a.useState(""),L=(s==null?void 0:s.points_balance)??0,c=a.useCallback(async()=>{try{g("");const t=await x("/api/rewards");I(Array.isArray(t)?t:t.rewards||t.items||[])}catch(t){g(t.message||"The treasure shop is temporarily closed.")}},[]);a.useEffect(()=>{c().finally(()=>B(!1))},[c]),a.useEffect(()=>{const t=()=>{c()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[c]);const O=()=>{b(null),j({...F}),o(""),f(!0)},K=t=>{b(t),j({title:t.title||"",description:t.description||"",point_cost:t.point_cost??t.cost??50,icon:t.icon||"",stock:t.stock!=null?String(t.stock):""}),o(""),f(!0)},y=()=>{f(!1),b(null),o("")},d=(t,i)=>{j(m=>({...m,[t]:i}))},Y=async()=>{if(!n.title.trim()){o("Every treasure needs a name!");return}if(Number(n.point_cost)<1){o("The cost must be at least 1 XP.");return}P(!0),o("");const t={title:n.title.trim(),description:n.description.trim(),point_cost:Number(n.point_cost),icon:n.icon||void 0};n.stock!==""&&(t.stock=Number(n.stock));try{u?await x(`/api/rewards/${u.id}`,{method:"PUT",body:t}):await x("/api/rewards",{method:"POST",body:t}),y(),await c()}catch(i){o(i.message||"Could not save the treasure.")}finally{P(!1)}},H=async()=>{if(r){_(!0);try{await x(`/api/rewards/${r.id}`,{method:"DELETE"}),p(null),await c()}catch(t){g(t.message||"Failed to remove the treasure.")}finally{_(!1)}}},V=async t=>{z(t.id),v("");try{await x(`/api/rewards/${t.id}/redeem`,{method:"POST"});const i=t.point_cost??t.cost??0;D({points_balance:((s==null?void 0:s.points_balance)??0)-i}),v(`You claimed "${t.title}"! Check your inventory, hero!`),await c()}catch(i){v(i.message||"Redemption failed. The shopkeeper is confused.")}finally{z(null)}},W=t=>L>=(t.point_cost??t.cost??0),q=t=>t.stock!=null&&t.stock<=0;return U?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[e.jsx($,{size:48,className:"text-sky animate-pulse"}),e.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"The shopkeeper is arranging the treasures..."})]}):e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Treasure Shop"})]}),h&&e.jsxs("button",{onClick:O,className:"game-btn game-btn-blue flex items-center gap-2",children:[e.jsx(A,{size:16}),"Add Treasure"]})]}),C&&e.jsx("div",{className:"game-panel p-5",children:e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gold/20 border-2 border-gold/40 flex items-center justify-center",children:e.jsx(k,{size:28,className:"text-gold"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted text-sm",children:"Your XP Balance"}),e.jsxs("p",{className:"text-gold text-xl font-extrabold",children:[L.toLocaleString()," XP"]})]})]})}),w&&e.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:w}),l&&e.jsxs("div",{className:`p-3 rounded border-2 text-sm text-center ${l.toLowerCase().includes("fail")||l.toLowerCase().includes("confused")||l.toLowerCase().includes("insufficient")?"border-crimson/40 bg-crimson/10 text-crimson":"border-emerald/40 bg-emerald/10 text-emerald"}`,children:[l," ",!l.toLowerCase().includes("fail")&&!l.toLowerCase().includes("confused")&&!l.toLowerCase().includes("insufficient")&&e.jsx("button",{onClick:()=>X("/inventory"),className:"underline font-bold hover:brightness-125 transition-all",children:"View Inventory"})]}),S.length===0?e.jsxs("div",{className:"game-panel p-10 text-center",children:[e.jsx(ee,{size:48,className:"mx-auto text-cream/20 mb-4"}),e.jsx("p",{className:"text-muted text-sm",children:"The treasure shop is empty. No loot to be found... yet!"}),h&&e.jsxs("button",{onClick:O,className:"game-btn game-btn-blue mt-4 inline-flex items-center gap-2",children:[e.jsx(A,{size:16}),"Stock First Treasure"]})]}):e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:S.map(t=>{const i=q(t),m=W(t),J=t.point_cost??t.cost??0;return e.jsxs("div",{className:`game-panel p-5 flex flex-col gap-3 relative ${i?"opacity-60":""}`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-sky/10 border border-sky/20 flex items-center justify-center flex-shrink-0",children:t.icon?e.jsx("span",{className:"text-2xl",children:t.icon}):e.jsx(te,{size:22,className:"text-sky"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-cream text-lg font-bold leading-relaxed",children:t.title}),t.description&&e.jsx("p",{className:"text-muted text-sm mt-1 line-clamp-2",children:t.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{size:16,className:"text-gold"}),e.jsxs("span",{className:"text-gold text-sm font-bold",children:[J," XP"]})]}),t.stock!=null&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(se,{size:14,className:i?"text-crimson":"text-muted"}),i?e.jsx("span",{className:"text-crimson text-xs font-bold",children:"Sold Out"}):e.jsxs("span",{className:"text-muted text-xs",children:[t.stock," left"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-auto pt-2",children:[C&&e.jsxs("button",{onClick:()=>V(t),disabled:!m||i||N===t.id,className:`game-btn game-btn-gold flex-1 flex items-center justify-center gap-2 ${!m||i?"opacity-40 cursor-not-allowed":""} ${N===t.id?"opacity-60 cursor-wait":""}`,children:[e.jsx(k,{size:14}),N===t.id?"Claiming...":m?i?"Sold Out":"Redeem":"Not Enough XP"]}),h&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>K(t),className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-sky","aria-label":"Edit reward",children:e.jsx(ae,{size:16})}),e.jsx("button",{onClick:()=>p(t),className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-crimson","aria-label":"Delete reward",children:e.jsx(ie,{size:16})})]})]})]},t.id)})}),e.jsx(M,{isOpen:G,onClose:y,title:u?"Edit Treasure":"New Treasure",actions:[{label:"Cancel",onClick:y,className:"game-btn game-btn-blue"},{label:E?"Saving...":u?"Update Treasure":"Add Treasure",onClick:Y,className:"game-btn game-btn-gold",disabled:E}],children:e.jsxs("div",{className:"space-y-4",children:[T&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:T}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Treasure Name"}),e.jsx("input",{type:"text",value:n.title,onChange:t=>d("title",t.target.value),placeholder:"Extra Screen Time",className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Description"}),e.jsx("textarea",{value:n.description,onChange:t=>d("description",t.target.value),placeholder:"What does this treasure grant?",rows:3,className:"field-input resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Cost (XP)"}),e.jsx("input",{type:"number",min:1,value:n.point_cost,onChange:t=>d("point_cost",t.target.value),className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Icon (Emoji)"}),e.jsx("input",{type:"text",value:n.icon,onChange:t=>d("icon",t.target.value),placeholder:"e.g. trophy, star, gift",className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Stock (Optional)"}),e.jsx("input",{type:"number",min:0,value:n.stock,onChange:t=>d("stock",t.target.value),placeholder:"Leave empty for unlimited",className:"field-input"}),e.jsx("p",{className:"text-muted text-xs mt-1",children:"Leave empty for unlimited supply."})]})]})}),e.jsx(M,{isOpen:!!r,onClose:()=>p(null),title:"Remove Treasure?",actions:[{label:"Keep Treasure",onClick:()=>p(null),className:"game-btn game-btn-blue"},{label:R?"Removing...":"Remove Treasure",onClick:H,className:"game-btn game-btn-red",disabled:R}],children:e.jsxs("p",{className:"text-muted",children:["Are you sure you want to remove"," ",e.jsxs("span",{className:"text-gold font-bold",children:['"',r==null?void 0:r.title,'"']})," ","from the treasure shop? Heroes can no longer redeem this reward."]})})]})}export{ue as default};
