import{r as o,j as e,b as I,u as G,c as U,d as X,a as K,e as H}from"./index-BvVEeEi_.js";import{t as Q}from"./questThemeText-CAVAuChl.js";import{S as q}from"./star-DfM-Wdx1.js";import{m as k}from"./proxy-AvjMb2bh.js";import{F}from"./flame-D4QbSI98.js";import{A as W}from"./index-85N6Q34R.js";import{T as Y}from"./triangle-alert-CAswkkN9.js";import{S as Z}from"./sword-BgO6K8Kr.js";import{C as J}from"./chevron-right-q1pKhCxU.js";import{C as ee}from"./camera-Ci8fp8-X.js";function te({value:t=0,prefix:n="XP"}){const[a,r]=o.useState(t),s=o.useRef(t),l=o.useRef(null);return o.useEffect(()=>{const m=s.current,p=t;if(s.current=t,m===p){r(p);return}const w=p-m,S=Math.min(Math.abs(w)*15,1500),M=performance.now();function g(z){const T=z-M,b=Math.min(T/S,1),x=1-Math.pow(1-b,3),E=Math.round(m+w*x);r(E),b<1&&(l.current=requestAnimationFrame(g))}return l.current=requestAnimationFrame(g),()=>{l.current&&cancelAnimationFrame(l.current)}},[t]),e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[e.jsx(q,{size:16,className:"text-gold fill-gold"}),e.jsxs("span",{className:"font-heading text-gold text-sm font-bold tabular-nums",children:[a.toLocaleString()," ",n]})]})}const se={scale:[1,1.1,.97,1.05,1],rotate:[-1,2,-2,1,0],transition:{duration:1,repeat:1/0,repeatType:"mirror",ease:"easeInOut"}};function ae(t){return t>=30?{size:28,className:"text-orange-400 drop-shadow-[0_0_8px_rgba(251,146,60,0.5)]"}:t>=7?{size:22,className:"text-orange-400"}:{size:18,className:"text-orange-400/70"}}function ne({streak:t=0,longest:n=0}){const[a,r]=o.useState(!1),s=ae(t),l=t>=30;return e.jsxs("div",{className:"relative inline-flex items-center gap-1",onMouseEnter:()=>r(!0),onMouseLeave:()=>r(!1),children:[l?e.jsx(k.div,{animate:se,className:"flex items-center",children:e.jsx(F,{size:s.size,className:s.className})}):e.jsx(F,{size:s.size,className:s.className}),e.jsx("span",{className:"font-bold text-orange-400 text-sm tabular-nums",children:t}),a&&e.jsxs("div",{className:"absolute bottom-full right-0 mb-2 px-3 py-1.5 bg-surface-raised border border-border rounded-lg text-center whitespace-nowrap z-10 shadow-lg",children:[e.jsxs("p",{className:"text-cream text-xs font-medium",children:[t," day streak"]}),e.jsxs("p",{className:"text-muted text-[10px]",children:["Best: ",n]}),e.jsx("div",{className:"absolute top-full right-3 w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-t-[5px] border-t-border"})]})]})}const $=["#3b82f6","#10b981","#f59e0b","#a855f7","#ef4444","#60a5fa"],re=30,L=3;function R(t,n){return Math.random()*(n-t)+t}function oe(){return Array.from({length:re},(t,n)=>{const a=R(0,Math.PI*2),r=R(200,500),s=R(6,14),l=Math.random()>.5?"circle":"rect";return{id:n,color:$[Math.floor(Math.random()*$.length)],x:Math.cos(a)*r,y:Math.sin(a)*r,rotation:R(0,720),size:s,shape:l}})}function B({onComplete:t}){const[n,a]=o.useState(!0),r=o.useMemo(()=>oe(),[]);return o.useEffect(()=>{const s=setTimeout(()=>{a(!1),t==null||t()},L*1e3);return()=>clearTimeout(s)},[t]),e.jsx(W,{children:n&&e.jsx("div",{className:"fixed inset-0 z-[100] pointer-events-none overflow-hidden",children:r.map(s=>e.jsx(k.div,{className:"absolute",style:{left:"50%",top:"40%",width:s.shape==="circle"?s.size:s.size*.7,height:s.size,backgroundColor:s.color,borderRadius:s.shape==="circle"?"50%":"2px"},initial:{x:0,y:0,opacity:1,rotate:0,scale:1},animate:{x:s.x,y:[0,s.y*.4,s.y+300],opacity:[1,1,0],rotate:s.rotation,scale:[1,1.2,.5]},transition:{duration:L,ease:[.25,.46,.45,.94],y:{duration:L,ease:[.22,.61,.36,1]}}},s.id))})})}const _=[{value:1,color:"#ef4444"},{value:5,color:"#f59e0b"},{value:2,color:"#10b981"},{value:10,color:"#a855f7"},{value:3,color:"#3b82f6"},{value:15,color:"#f97316"},{value:1,color:"#ec4899"},{value:25,color:"#f59e0b"},{value:2,color:"#06b6d4"},{value:5,color:"#10b981"},{value:3,color:"#a855f7"},{value:10,color:"#ef4444"}],P=360/_.length;function O(t,n,a,r){const s=(r-90)*Math.PI/180;return{x:t+a*Math.cos(s),y:n+a*Math.sin(s)}}function ie(t,n,a,r,s){const l=O(t,n,a,s),m=O(t,n,a,r),p=s-r<=180?"0":"1";return["M",t,n,"L",l.x,l.y,"A",a,a,0,p,0,m.x,m.y,"Z"].join(" ")}function le({availability:t,onSpinComplete:n}){const[a,r]=o.useState(!1),[s,l]=o.useState(0),[m,p]=o.useState(null),[w,S]=o.useState(!1),[M,g]=o.useState(null),z=o.useRef(!1),T=(t==null?void 0:t.can_spin)??!0,b=(t==null?void 0:t.reason)??null,x=!T,E=o.useCallback(async()=>{if(!(a||x)){r(!0),p(null),g(null);try{const h=await I("/api/spin/spin",{method:"POST"}),i=h.points_won??h.points??h.result??5,d=_.reduce((v,C,D)=>(C.value===i&&v.push(D),v),[]),c=(d.length>0?d[Math.floor(Math.random()*d.length)]:Math.floor(Math.random()*_.length))*P+P/2,f=5+Math.floor(Math.random()*3),A=s+f*360+(360-c);l(A),setTimeout(()=>{p(i),S(!0),r(!1),z.current=!0,n==null||n(i)},3500)}catch(h){g(h.message||"Spin failed!"),r(!1)}}},[a,x,s,n]),u=150,j=150,y=140;return e.jsxs("div",{className:"flex flex-col items-center gap-5",children:[w&&e.jsx(B,{onComplete:()=>S(!1)}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1 z-10",children:e.jsx("div",{className:"w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[20px] border-t-sky",style:{filter:"drop-shadow(0 2px 6px rgba(59,130,246,0.4))"}})}),e.jsx(k.div,{animate:{rotate:s},transition:{duration:3.5,ease:[.2,.8,.3,1]},className:"w-[260px] h-[260px] sm:w-[300px] sm:h-[300px]",children:e.jsxs("svg",{viewBox:"0 0 300 300",className:"w-full h-full drop-shadow-xl",children:[e.jsx("circle",{cx:u,cy:j,r:y+4,fill:"none",stroke:"#1e293b",strokeWidth:"4"}),_.map((h,i)=>{const d=i*P,N=d+P,c=d+P/2,f=O(u,j,y*.65,c);return e.jsxs("g",{children:[e.jsx("path",{d:ie(u,j,y,d,N),fill:h.color,stroke:"#0a0e1a",strokeWidth:"2",opacity:x&&!a?.4:.9}),e.jsx("text",{x:f.x,y:f.y,textAnchor:"middle",dominantBaseline:"central",fill:"white",fontFamily:"Inter, system-ui, sans-serif",fontSize:"12",fontWeight:"800",transform:`rotate(${c}, ${f.x}, ${f.y})`,children:h.value})]},i)}),e.jsx("circle",{cx:u,cy:j,r:22,fill:"#111827",stroke:"#1e293b",strokeWidth:"3"}),e.jsx("circle",{cx:u,cy:j,r:10,fill:"#3b82f6"})]})})]}),m!==null&&e.jsxs("div",{className:"game-panel px-6 py-3 text-center",children:[e.jsx("p",{className:"text-muted text-xs",children:"You won"}),e.jsxs("p",{className:"text-gold text-lg font-bold mt-1",children:[m," XP"]})]}),x&&!a&&b&&e.jsx("p",{className:"text-gold text-sm text-center max-w-xs",children:b}),M&&e.jsx("p",{className:"text-crimson text-sm text-center",children:M}),e.jsx("button",{onClick:E,disabled:a||x,className:`game-btn game-btn-blue text-base px-10 py-3 ${a||x?"opacity-50 cursor-not-allowed":""}`,children:a?"SPINNING...":x?"LOCKED":"SPIN!"})]})}function ce(){const t=new Date,n=t.getDay(),a=n===0?-6:1-n,r=new Date(t);return r.setDate(t.getDate()+a),r.toISOString().slice(0,10)}function de(){return new Date().toISOString().slice(0,10)}function me(t){switch(t){case"easy":return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"};case"medium":return{text:"Medium",color:"text-gold bg-gold/10 border-gold/20"};case"hard":return{text:"Hard",color:"text-orange-400 bg-orange-400/10 border-orange-400/20"};case"expert":return{text:"Expert",color:"text-crimson bg-crimson/10 border-crimson/20"};default:return{text:"Easy",color:"text-emerald bg-emerald/10 border-emerald/20"}}}const xe={hidden:{opacity:0,y:12},visible:t=>({opacity:1,y:0,transition:{delay:t*.05,type:"spring",stiffness:300,damping:28}})};function we(){const{user:t,updateUser:n}=G(),{spin_wheel_enabled:a}=U(),{colorTheme:r}=X(),s=K(),[l,m]=o.useState([]),[p,w]=o.useState([]),[S,M]=o.useState(null),[g,z]=o.useState(!0),[T,b]=o.useState(null),[x,E]=o.useState(!1),u=o.useCallback(async()=>{try{b(null);const i=ce(),d=de(),N=[I("/api/chores"),I(`/api/calendar?week_start=${i}`)];a&&N.push(I("/api/spin/availability"));const c=await Promise.all(N),f=c[0],A=c[1],v=a?c[2]:null;w(f);const D=(A.days&&A.days[d]||[]).filter(V=>V.user_id===(t==null?void 0:t.id));m(D),M(v)}catch(i){b(i.message||"Failed to load quest data")}finally{z(!1)}},[t==null?void 0:t.id,a]);if(o.useEffect(()=>{u()},[u]),o.useEffect(()=>{const i=()=>{u()};return window.addEventListener("ws:message",i),()=>window.removeEventListener("ws:message",i)},[u]),g)return e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(H,{className:"animate-spin text-sky",size:28})});const j=l.filter(i=>i.status==="verified"||i.status==="completed").length,y=l.length,h=y>0?Math.round(j/y*100):0;return e.jsxs("div",{className:"max-w-2xl mx-auto space-y-5",children:[e.jsx(W,{children:x&&e.jsx(B,{onComplete:()=>E(!1)})}),e.jsxs("div",{className:"game-panel p-5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 flex-wrap mb-4",children:[e.jsx("h1",{className:"font-heading text-cream text-xl font-extrabold",children:"Quest Board"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(te,{value:(t==null?void 0:t.points_balance)??0}),e.jsx(ne,{streak:(t==null?void 0:t.current_streak)??0})]})]}),y>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("span",{className:"text-muted text-xs font-medium",children:"Today's Progress"}),e.jsxs("span",{className:"text-cream text-xs font-bold",children:[j,"/",y]})]}),e.jsx("div",{className:"xp-bar",children:e.jsx(k.div,{className:"xp-bar-fill",initial:{width:0},animate:{width:`${h}%`},transition:{duration:.8,ease:[.22,1,.36,1]}})})]})]}),T&&e.jsxs("div",{className:"game-panel p-3 flex items-center gap-2 border-crimson/30 text-crimson text-sm",children:[e.jsx(Y,{size:16}),e.jsx("span",{children:T})]}),(()=>{const i=l.filter(d=>d.status==="pending"||d.status==="assigned");return i.length===0&&!g?e.jsxs(k.div,{className:"game-panel p-10 flex flex-col items-center gap-3 text-center",initial:{opacity:0,y:12},animate:{opacity:1,y:0},children:[e.jsx(Z,{size:36,className:"text-muted"}),e.jsx("p",{className:"text-muted text-sm",children:l.length===0?"No quests for today. Take a break!":"All quests complete! Time to spin the wheel!"})]}):e.jsx("div",{className:"space-y-3",children:i.map((d,N)=>{var v,C;const c=d.chore;if(!c)return null;const f=me(c.difficulty),A=((v=c.category)==null?void 0:v.colour)||"#3b82f6";return e.jsx(k.div,{className:"game-panel p-4 transition-all cursor-pointer hover:border-sky/40",variants:xe,initial:"hidden",animate:"visible",custom:N,onClick:()=>s("/chores"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-0.5 w-1 h-12 rounded-full flex-shrink-0",style:{backgroundColor:A}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1.5",children:[e.jsx("h3",{className:"text-cream text-sm font-semibold truncate",children:Q(c.title,r)}),e.jsx(J,{size:16,className:"text-muted flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 text-gold text-xs font-semibold",children:[e.jsx(q,{size:12,fill:"currentColor"}),c.points," XP"]}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold border ${f.color}`,children:f.text}),((C=c.category)==null?void 0:C.name)&&e.jsx("span",{className:"text-muted text-xs",children:c.category.name}),c.requires_photo&&e.jsxs("span",{className:"inline-flex items-center gap-1 text-muted text-xs",children:[e.jsx(ee,{size:10}),"Photo"]})]})]})]})},d.id)})})})(),a&&e.jsx("div",{className:"pt-2",children:e.jsx(le,{availability:S,onSpinComplete:()=>{u()}})})]})}export{we as default};
