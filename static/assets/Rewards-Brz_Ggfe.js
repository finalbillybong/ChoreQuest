import{u as ee,r as n,b as w,j as e,e as ne,G as Q,i as he,f as V,a as ge,k as fe}from"./index-DyDiUpYc.js";import{M as se}from"./Modal-DYBvm5YE.js";import{P as J,E as be,C as G,S as Z,L as je,a as ye}from"./shopping-bag-DjR710nN.js";import{C as ve}from"./clock-Zla1PGkY.js";import{S as M}from"./star-CIYm8Jtg.js";import{P as te}from"./plus-Dj6ox8SW.js";import{C as ae}from"./check-xEzOej_z.js";import{T as oe}from"./trash-2-BuaqhUTT.js";import{F as Ne}from"./flame-BR6AwHEh.js";import{F as ke}from"./filter-BHDZbTx2.js";import{P as we}from"./pencil-DEO1fYmS.js";import"./index-ENwDjcP0.js";import"./proxy-B2dJm0uC.js";function Ce(){const{user:i}=ee(),x=(i==null?void 0:i.role)==="kid",[o,C]=n.useState([]),[h,g]=n.useState(!0),[f,y]=n.useState(""),[N,S]=n.useState(null),b=n.useCallback(async()=>{g(!0),y("");try{const r=await w("/api/rewards/redemptions");C(r)}catch(r){y(r.message||"Failed to load inventory")}finally{g(!1)}},[]);n.useEffect(()=>{b()},[b]),n.useEffect(()=>{const r=()=>{b()};return window.addEventListener("ws:message",r),()=>window.removeEventListener("ws:message",r)},[b]);const _=async r=>{S(r.id);try{await w(`/api/rewards/redemptions/${r.id}/fulfill`,{method:"POST"}),await b()}catch(c){y(c.message||"Could not mark as given")}finally{S(null)}},j=o.filter(r=>r.status==="approved"),u=o.filter(r=>r.status==="pending"),E=r=>{var p,a;const c={};for(const d of r){const l=((p=d.user)==null?void 0:p.display_name)||((a=d.user)==null?void 0:a.username)||`Kid #${d.user_id}`;c[l]||(c[l]=[]),c[l].push(d)}return Object.entries(c).sort(([d],[l])=>d.localeCompare(l))};return e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(J,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:x?"My Inventory":"Reward Inventory"})]}),f&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:f}),h&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(ne,{size:32,className:"text-sky animate-spin"})}),!h&&e.jsxs(e.Fragment,{children:[j.length===0&&u.length===0&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(J,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:x?"No loot yet!":"No claimed rewards"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:x?"Complete quests, earn XP, and redeem rewards to fill your inventory.":"When kids redeem rewards, they'll appear here."})]}),x&&(j.length>0||u.length>0)&&e.jsxs("div",{className:"space-y-6",children:[j.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted text-[11px] font-semibold uppercase tracking-widest mb-3",children:"Ready to collect"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:j.map(r=>e.jsx(q,{redemption:r,status:"approved"},r.id))})]}),u.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted text-[11px] font-semibold uppercase tracking-widest mb-3",children:"Awaiting approval"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:u.map(r=>e.jsx(q,{redemption:r,status:"pending"},r.id))})]})]}),!x&&(j.length>0||u.length>0)&&e.jsxs("div",{className:"space-y-6",children:[j.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted text-[11px] font-semibold uppercase tracking-widest mb-3",children:"Waiting to be given out"}),E(j).map(([r,c])=>e.jsxs("div",{className:"mb-5",children:[e.jsx("p",{className:"text-cream text-sm font-bold mb-2",children:r}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:c.map(p=>e.jsx(q,{redemption:p,status:"approved",showFulfill:!0,onFulfill:()=>_(p),fulfilling:N===p.id},p.id))})]},r))]}),u.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted text-[11px] font-semibold uppercase tracking-widest mb-3",children:"Pending approval"}),E(u).map(([r,c])=>e.jsxs("div",{className:"mb-5",children:[e.jsx("p",{className:"text-cream text-sm font-bold mb-2",children:r}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:c.map(p=>e.jsx(q,{redemption:p,status:"pending"},p.id))})]},r))]})]})]})]})}function q({redemption:i,status:x,showFulfill:o,onFulfill:C,fulfilling:h}){const g=i.reward,f=(g==null?void 0:g.icon)||"ðŸŽ";return e.jsxs("div",{className:`game-panel !border-2 p-4 flex items-center gap-3 ${x==="approved"?"border-emerald/40 bg-emerald/5":"border-border bg-surface-raised/30"}`,children:[e.jsx("div",{className:"text-2xl flex-shrink-0",children:f}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-cream text-sm font-bold truncate",children:(g==null?void 0:g.title)||"Reward"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[x==="approved"?e.jsxs("span",{className:"flex items-center gap-1 text-emerald text-xs",children:[e.jsx(Q,{size:12})," Approved"]}):e.jsxs("span",{className:"flex items-center gap-1 text-muted text-xs",children:[e.jsx(ve,{size:12})," Pending"]}),e.jsxs("span",{className:"text-muted text-xs",children:[i.points_spent," XP"]})]}),i.created_at&&e.jsxs("p",{className:"text-muted/60 text-[10px] mt-1",children:["Claimed ",new Date(i.created_at).toLocaleDateString()]})]}),o&&e.jsxs("button",{onClick:C,disabled:h,className:"game-btn game-btn-blue flex items-center gap-1 text-xs !py-1.5 !px-3 flex-shrink-0",title:"Mark as given out",children:[e.jsx(he,{size:14}),h?"...":"Given"]})]})}function Se(){const{user:i}=ee(),x=(i==null?void 0:i.role)==="kid",[o,C]=n.useState([]),[h,g]=n.useState(!0),[f,y]=n.useState(""),[N,S]=n.useState(!1),[b,_]=n.useState(""),[j,u]=n.useState(""),[E,r]=n.useState(""),[c,p]=n.useState(!1),[a,d]=n.useState(!1),[l,k]=n.useState(null),[R,T]=n.useState(""),[L,I]=n.useState(!1),[D,O]=n.useState(""),z=n.useCallback(async()=>{g(!0),y("");try{const t=await w("/api/wishlist");C(t.items||t||[])}catch(t){y(t.message||"Failed to load wishlist")}finally{g(!1)}},[]);n.useEffect(()=>{z()},[z]),n.useEffect(()=>{const t=()=>{z()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[z]);const K=async()=>{if(b.trim()){p(!0);try{const t={title:b.trim()};j.trim()&&(t.url=j.trim()),E.trim()&&(t.notes=E.trim()),await w("/api/wishlist",{method:"POST",body:t}),_(""),u(""),r(""),S(!1),z()}catch(t){y(t.message||"Failed to add item")}finally{p(!1)}}},P=async t=>{try{await w(`/api/wishlist/${t}`,{method:"DELETE"}),C(v=>v.filter(X=>X.id!==t))}catch(v){y(v.message||"Failed to delete item")}},W=t=>{k(t),T(""),O(""),d(!0)},A=async()=>{const t=parseInt(R,10);if(!t||t<=0){O("Enter a valid point cost");return}I(!0),O("");try{await w(`/api/wishlist/${l.id}/convert`,{method:"POST",body:{point_cost:t}}),d(!1),z()}catch(v){O(v.message||"Conversion failed")}finally{I(!1)}},$={};x||o.forEach(t=>{const v=t.user_display_name||t.username||t.user_id||"Unknown Hero";$[v]||($[v]=[]),$[v].push(t)});const U=(t,v=!1,X=!1)=>{const F=!!t.converted_to_reward_id;return e.jsxs("div",{className:`game-panel p-4 flex items-start gap-3 ${F?"!border-emerald/40":""}`,children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:F?e.jsx(ae,{size:18,className:"text-emerald"}):e.jsx(M,{size:18,className:"text-sky"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-cream text-sm leading-tight",children:t.title}),t.url&&e.jsxs("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",className:"text-sky text-xs flex items-center gap-1 mt-1 hover:text-sky/80 transition-colors",children:[e.jsx(be,{size:12}),e.jsx("span",{className:"truncate",children:t.url})]}),t.notes&&e.jsx("p",{className:"text-muted text-xs mt-1",children:t.notes}),F&&e.jsx("span",{className:"inline-block mt-1 text-emerald text-xs font-medium",children:"Converted to Reward"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[X&&!F&&e.jsx("button",{onClick:()=>W(t),className:"game-btn game-btn-purple !py-2 !px-3 !text-[8px]",title:"Convert to Reward",children:e.jsx(Q,{size:14})}),v&&e.jsx("button",{onClick:()=>P(t.id),className:"p-2 rounded hover:bg-crimson/10 text-crimson/60 hover:text-crimson transition-colors",title:"Delete",children:e.jsx(oe,{size:16})})]})]},t.id)};return e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(M,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Wish List"})]}),x&&e.jsxs("button",{onClick:()=>S(!N),className:"game-btn game-btn-blue flex items-center gap-2",children:[e.jsx(te,{size:14}),"Add Wish"]})]}),f&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:f}),x&&N&&e.jsxs("div",{className:"game-panel p-5 mb-6 space-y-3",children:[e.jsx("h3",{className:"text-cream text-lg font-bold tracking-wide mb-3",children:"New Wish"}),e.jsx("input",{type:"text",value:b,onChange:t=>_(t.target.value),placeholder:"What do you wish for?",className:"field-input"}),e.jsx("input",{type:"url",value:j,onChange:t=>u(t.target.value),placeholder:"Link (optional)",className:"field-input"}),e.jsx("textarea",{value:E,onChange:t=>r(t.target.value),placeholder:"Notes (optional)",rows:2,className:"field-input resize-none"}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>S(!1),className:"game-btn game-btn-red",children:"Cancel"}),e.jsx("button",{onClick:K,disabled:c||!b.trim(),className:"game-btn game-btn-blue",children:c?"Adding...":"Add Wish"})]})]}),h&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(ne,{size:32,className:"text-sky animate-spin"})}),!h&&x&&e.jsx("div",{className:"space-y-3",children:o.length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx(M,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"Your wish list is empty"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"Every hero has dreams. Add your first wish!"})]}):o.map(t=>U(t,!0,!1))}),!h&&!x&&e.jsx("div",{className:"space-y-8",children:Object.keys($).length===0?e.jsxs("div",{className:"text-center py-16",children:[e.jsx(M,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No wishes yet"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"Your heroes haven't made any wishes yet. Encourage them to dream!"})]}):Object.entries($).map(([t,v])=>e.jsxs("div",{children:[e.jsxs("h2",{className:"text-cream text-lg font-bold mb-3 tracking-wide flex items-center gap-2",children:[e.jsx(M,{size:14,className:"text-sky"}),t,"'s Wishes"]}),e.jsx("div",{className:"space-y-3",children:v.map(X=>U(X,!1,!0))})]},t))}),e.jsx(se,{isOpen:a,onClose:()=>d(!1),title:"Convert to Reward",actions:[{label:"Cancel",onClick:()=>d(!1),className:"game-btn game-btn-red"},{label:L?"Converting...":"Convert",onClick:A,className:"game-btn game-btn-gold",disabled:L}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Convert"," ",e.jsx("span",{className:"text-cream font-bold",children:l==null?void 0:l.title})," ","into a redeemable reward:"]}),D&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:D}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gold text-sm font-medium mb-2 tracking-wide",children:"Point Cost (XP)"}),e.jsx("input",{type:"number",min:"1",value:R,onChange:t=>T(t.target.value),placeholder:"e.g. 500",className:"field-input"})]})]})})]})}const _e={common:"border-border text-muted",uncommon:"border-sky/40 text-sky",rare:"border-purple/40 text-purple",epic:"border-gold/40 text-gold",legendary:"border-crimson/40 text-crimson"},Ee={common:"bg-surface-raised/30",uncommon:"bg-sky/5",rare:"bg-purple/5",epic:"bg-gold/5",legendary:"bg-crimson/5"},ze={common:"bg-border text-muted",uncommon:"bg-sky/20 text-sky",rare:"bg-purple/20 text-purple",epic:"bg-gold/20 text-gold",legendary:"bg-crimson/20 text-crimson"},re={head:"Head",hair:"Hair",eyes:"Eyes",mouth:"Mouth",hat:"Hats",accessory:"Gear",face_extra:"Face",outfit_pattern:"Pattern",pet:"Pets"},le=["hat","pet","accessory","hair","eyes","mouth","face_extra","outfit_pattern","head"];function Pe(i){switch(i.unlock_method){case"shop":return`${i.unlock_value} XP`;case"xp":return`Earn ${i.unlock_value} XP`;case"streak":return`${i.unlock_value}-day streak`;case"quest_drop":return"Quest drop";default:return"Free"}}function Te({method:i}){switch(i){case"shop":return e.jsx(G,{size:12});case"xp":return e.jsx(M,{size:12});case"streak":return e.jsx(Ne,{size:12});case"quest_drop":return e.jsx(V,{size:12});default:return null}}function Le(){const{user:i,updateUser:x}=ee(),o=(i==null?void 0:i.role)==="parent"||(i==null?void 0:i.role)==="admin",[C,h]=n.useState([]),[g,f]=n.useState(!0),[y,N]=n.useState(null),[S,b]=n.useState(""),[_,j]=n.useState("all"),u=n.useCallback(async()=>{try{const a=await w("/api/avatar/items");h(Array.isArray(a)?a:[])}catch{h([])}},[]);n.useEffect(()=>{u().finally(()=>f(!1))},[u]),n.useEffect(()=>{const a=()=>u();return window.addEventListener("ws:message",a),()=>window.removeEventListener("ws:message",a)},[u]);const E=async a=>{N(a.id),b("");try{const d=await w(`/api/avatar/items/${a.id}/purchase`,{method:"POST"});x({points_balance:d.points_balance}),b(`Unlocked ${a.display_name}!`),await u()}catch(d){b(d.message||"Purchase failed")}finally{N(null),setTimeout(()=>b(""),3e3)}},r=C.filter(a=>!a.is_default),c={};for(const a of r)_!=="all"&&a.category!==_||(c[a.category]||(c[a.category]=[]),c[a.category].push(a));const p=(i==null?void 0:i.points_balance)??0;return g?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[e.jsx(V,{size:48,className:"text-purple animate-pulse"}),e.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"Loading avatar items..."})]}):e.jsxs("div",{className:"space-y-4",children:[o?e.jsxs("div",{className:"game-panel p-3 flex items-center gap-2 text-emerald text-sm",children:[e.jsx(ae,{size:16}),e.jsx("span",{className:"font-medium",children:"All avatar items are unlocked for parents."})]}):e.jsxs("div",{className:"game-panel p-3 flex items-center justify-between",children:[e.jsx("span",{className:"text-cream text-sm font-medium",children:"Your XP"}),e.jsxs("span",{className:"flex items-center gap-1 text-gold text-sm font-bold",children:[e.jsx(G,{size:14}),p]})]}),S&&e.jsx("div",{className:`p-2 rounded border text-sm ${S.includes("Unlocked")?"border-emerald/40 bg-emerald/10 text-emerald":"border-crimson/40 bg-crimson/10 text-crimson"}`,children:S}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>j("all"),className:`px-3 py-1.5 rounded-lg border text-xs font-medium transition-all ${_==="all"?"border-sky bg-sky/15 text-sky":"border-border text-muted hover:text-cream"}`,children:"All"}),le.map(a=>r.some(l=>l.category===a)?e.jsx("button",{onClick:()=>j(a),className:`px-3 py-1.5 rounded-lg border text-xs font-medium transition-all ${_===a?"border-sky bg-sky/15 text-sky":"border-border text-muted hover:text-cream"}`,children:re[a]||a},a):null)]}),le.map(a=>{const d=c[a];return!d||d.length===0?null:e.jsxs("div",{children:[e.jsx("h3",{className:"text-cream text-sm font-bold mb-2",children:re[a]||a}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2",children:d.map(l=>{const k=l.unlocked,R=l.unlock_method==="shop"&&!k&&p>=(l.unlock_value||0),T=y===l.id;return e.jsxs("div",{className:`rounded-lg border p-3 transition-all ${_e[l.rarity]} ${Ee[l.rarity]} ${k?"opacity-70":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-1 mb-2",children:[e.jsx("span",{className:"text-cream text-xs font-medium leading-tight",children:l.display_name}),e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded-full font-medium ${ze[l.rarity]}`,children:l.rarity})]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted text-[11px] mb-2",children:[e.jsx(Te,{method:l.unlock_method}),Pe(l)]}),k?e.jsxs("div",{className:"flex items-center gap-1 text-emerald text-xs font-medium",children:[e.jsx(ae,{size:12}),"Owned"]}):l.unlock_method==="shop"?e.jsxs("button",{onClick:()=>E(l),disabled:!R||T,className:`w-full flex items-center justify-center gap-1 px-2 py-1.5 rounded border text-xs font-medium transition-all ${R?"border-gold/40 bg-gold/10 text-gold hover:bg-gold/20":"border-border text-muted cursor-not-allowed opacity-50"}`,children:[T?e.jsx(ne,{size:12,className:"animate-spin"}):e.jsx(Z,{size:12}),T?"Buying...":`Buy Â· ${l.unlock_value} XP`]}):e.jsxs("div",{className:"flex items-center gap-1 text-muted text-xs",children:[e.jsx(je,{size:12}),l.unlock_method==="quest_drop"?"Find in quests":l.unlock_method==="xp"?`Earn ${l.unlock_value} total XP`:l.unlock_method==="streak"?`${l.unlock_value}-day streak`:"Locked"]})]},l.id)})})]},a)}),Object.keys(c).length===0&&e.jsxs("div",{className:"text-center py-12 text-muted",children:[e.jsx(V,{size:32,className:"mx-auto mb-3 opacity-40"}),e.jsx("p",{className:"text-sm",children:"No items in this category."})]})]})}const ie={title:"",description:"",point_cost:50,icon:"",stock:"",category:""},$e=[{key:"shop",label:"Shop",icon:Z},{key:"avatar",label:"Avatar",icon:ye},{key:"inventory",label:"Inventory",icon:J},{key:"wishlist",label:"Wishlist",icon:M}];function Ke(){ge();const[i,x]=fe(),{user:o,updateUser:C}=ee(),h=(o==null?void 0:o.role)==="parent"||(o==null?void 0:o.role)==="admin",g=(o==null?void 0:o.role)==="kid",f=i.get("tab")||"shop",y=s=>x(s==="shop"?{}:{tab:s},{replace:!0}),[N,S]=n.useState([]),[b,_]=n.useState(!0),[j,u]=n.useState(""),[E,r]=n.useState(!1),[c,p]=n.useState(null),[a,d]=n.useState({...ie}),[l,k]=n.useState(""),[R,T]=n.useState(!1),[L,I]=n.useState(null),[D,O]=n.useState(!1),[z,K]=n.useState(null),[P,W]=n.useState(""),[A,$]=n.useState("all"),U=(o==null?void 0:o.points_balance)??0,t=n.useCallback(async()=>{try{u("");const s=await w("/api/rewards");S(Array.isArray(s)?s:s.rewards||s.items||[])}catch(s){u(s.message||"The treasure shop is temporarily closed.")}},[]);if(n.useEffect(()=>{t().finally(()=>_(!1))},[t]),n.useEffect(()=>{const s=()=>{t()};return window.addEventListener("ws:message",s),()=>window.removeEventListener("ws:message",s)},[t]),f==="avatar")return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsx(H,{activeTab:f,setTab:y}),e.jsx(Le,{})]});if(f==="inventory")return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsx(H,{activeTab:f,setTab:y}),e.jsx(Ce,{})]});if(f==="wishlist")return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsx(H,{activeTab:f,setTab:y}),e.jsx(Se,{})]});const v=()=>{p(null),d({...ie}),k(""),r(!0)},X=s=>{p(s),d({title:s.title||"",description:s.description||"",point_cost:s.point_cost??s.cost??50,icon:s.icon||"",stock:s.stock!=null?String(s.stock):"",category:s.category||""}),k(""),r(!0)},F=()=>{r(!1),p(null),k("")},B=(s,m)=>{d(Y=>({...Y,[s]:m}))},ce=async()=>{if(!a.title.trim()){k("Every treasure needs a name!");return}if(Number(a.point_cost)<1){k("The cost must be at least 1 XP.");return}T(!0),k("");const s={title:a.title.trim(),description:a.description.trim(),point_cost:Number(a.point_cost),icon:a.icon||void 0,category:a.category.trim()||void 0};a.stock!==""&&(s.stock=Number(a.stock));try{c?await w(`/api/rewards/${c.id}`,{method:"PUT",body:s}):await w("/api/rewards",{method:"POST",body:s}),F(),await t()}catch(m){k(m.message||"Could not save the treasure.")}finally{T(!1)}},de=async()=>{if(L){O(!0);try{await w(`/api/rewards/${L.id}`,{method:"DELETE"}),I(null),await t()}catch(s){u(s.message||"Failed to remove the treasure.")}finally{O(!1)}}},me=async s=>{K(s.id),W("");try{await w(`/api/rewards/${s.id}/redeem`,{method:"POST"});const m=s.point_cost??s.cost??0;C({points_balance:((o==null?void 0:o.points_balance)??0)-m}),W(`You claimed "${s.title}"! Check your inventory, hero!`),await t()}catch(m){W(m.message||"Redemption failed. The shopkeeper is confused.")}finally{K(null)}},xe=s=>U>=(s.point_cost??s.cost??0),ue=s=>s.stock!=null&&s.stock<=0;return b?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 gap-4",children:[e.jsx(Z,{size:48,className:"text-sky animate-pulse"}),e.jsx("p",{className:"text-cream text-lg font-bold animate-pulse",children:"The shopkeeper is arranging the treasures..."})]}):e.jsxs("div",{className:"max-w-5xl mx-auto space-y-6",children:[e.jsx(H,{activeTab:f,setTab:y}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Treasure Shop"})]}),h&&e.jsxs("button",{onClick:v,className:"game-btn game-btn-blue flex items-center gap-2",children:[e.jsx(te,{size:16}),"Add Treasure"]})]}),g&&e.jsx("div",{className:"game-panel p-5",children:e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gold/20 border-2 border-gold/40 flex items-center justify-center",children:e.jsx(G,{size:28,className:"text-gold"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-muted text-sm",children:"Your XP Balance"}),e.jsxs("p",{className:"text-gold text-xl font-extrabold",children:[U.toLocaleString()," XP"]})]})]})}),j&&e.jsx("div",{className:"p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:j}),(()=>{const s=[...new Set(N.map(m=>m.category).filter(Boolean))];return s.length===0?null:e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto pb-1",children:[e.jsx(ke,{size:14,className:"text-muted flex-shrink-0"}),e.jsx("button",{onClick:()=>$("all"),className:`px-3 py-1.5 rounded-full text-xs font-medium border transition-colors whitespace-nowrap ${A==="all"?"bg-sky/15 text-sky border-sky/25":"text-muted border-border hover:text-cream"}`,children:"All"}),s.map(m=>e.jsx("button",{onClick:()=>$(m),className:`px-3 py-1.5 rounded-full text-xs font-medium border transition-colors whitespace-nowrap ${A===m?"bg-sky/15 text-sky border-sky/25":"text-muted border-border hover:text-cream"}`,children:m},m))]})})(),P&&e.jsxs("div",{className:`p-3 rounded border-2 text-sm text-center ${P.toLowerCase().includes("fail")||P.toLowerCase().includes("confused")||P.toLowerCase().includes("insufficient")?"border-crimson/40 bg-crimson/10 text-crimson":"border-emerald/40 bg-emerald/10 text-emerald"}`,children:[P," ",!P.toLowerCase().includes("fail")&&!P.toLowerCase().includes("confused")&&!P.toLowerCase().includes("insufficient")&&e.jsx("button",{onClick:()=>y("inventory"),className:"underline font-bold hover:brightness-125 transition-all",children:"View Inventory"})]}),(A==="all"?N:N.filter(m=>m.category===A)).length===0&&N.length>0?e.jsxs("div",{className:"game-panel p-10 text-center",children:[e.jsx(Q,{size:48,className:"mx-auto text-cream/20 mb-4"}),e.jsx("p",{className:"text-muted text-sm",children:"No treasures in this category."}),e.jsx("button",{onClick:()=>$("all"),className:"text-sky text-xs mt-2 hover:underline",children:"Show all"})]}):N.length===0?e.jsxs("div",{className:"game-panel p-10 text-center",children:[e.jsx(Q,{size:48,className:"mx-auto text-cream/20 mb-4"}),e.jsx("p",{className:"text-muted text-sm",children:"The treasure shop is empty. No loot to be found... yet!"}),h&&e.jsxs("button",{onClick:v,className:"game-btn game-btn-blue mt-4 inline-flex items-center gap-2",children:[e.jsx(te,{size:16}),"Stock First Treasure"]})]}):e.jsx("div",{className:"grid gap-4 sm:grid-cols-2 lg:grid-cols-3",children:(A==="all"?N:N.filter(s=>s.category===A)).map(s=>{const m=ue(s),Y=xe(s),pe=s.point_cost??s.cost??0;return e.jsxs("div",{className:`game-panel p-5 flex flex-col gap-3 relative ${m?"opacity-60":""}`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg bg-sky/10 border border-sky/20 flex items-center justify-center flex-shrink-0",children:s.icon?e.jsx("span",{className:"text-2xl",children:s.icon}):e.jsx(V,{size:22,className:"text-sky"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-cream text-lg font-bold leading-relaxed",children:s.title}),s.description&&e.jsx("p",{className:"text-muted text-sm mt-1 line-clamp-2",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(G,{size:16,className:"text-gold"}),e.jsxs("span",{className:"text-gold text-sm font-bold",children:[pe," XP"]})]}),s.category&&e.jsx("span",{className:"px-2 py-0.5 rounded-full text-[10px] font-medium border border-purple/30 bg-purple/10 text-purple",children:s.category})]}),s.stock!=null&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(J,{size:14,className:m?"text-crimson":"text-muted"}),m?e.jsx("span",{className:"text-crimson text-xs font-bold",children:"Sold Out"}):e.jsxs("span",{className:"text-muted text-xs",children:[s.stock," left"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-auto pt-2",children:[g&&e.jsxs("button",{onClick:()=>me(s),disabled:!Y||m||z===s.id,className:`game-btn game-btn-gold flex-1 flex items-center justify-center gap-2 ${!Y||m?"opacity-40 cursor-not-allowed":""} ${z===s.id?"opacity-60 cursor-wait":""}`,children:[e.jsx(G,{size:14}),z===s.id?"Claiming...":Y?m?"Sold Out":"Redeem":"Not Enough XP"]}),h&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>X(s),className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-sky","aria-label":"Edit reward",children:e.jsx(we,{size:16})}),e.jsx("button",{onClick:()=>I(s),className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-crimson","aria-label":"Delete reward",children:e.jsx(oe,{size:16})})]})]})]},s.id)})}),e.jsx(se,{isOpen:E,onClose:F,title:c?"Edit Treasure":"New Treasure",actions:[{label:"Cancel",onClick:F,className:"game-btn game-btn-blue"},{label:R?"Saving...":c?"Update Treasure":"Add Treasure",onClick:ce,className:"game-btn game-btn-gold",disabled:R}],children:e.jsxs("div",{className:"space-y-4",children:[l&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:l}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Treasure Name"}),e.jsx("input",{type:"text",value:a.title,onChange:s=>B("title",s.target.value),placeholder:"Extra Screen Time",className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Description"}),e.jsx("textarea",{value:a.description,onChange:s=>B("description",s.target.value),placeholder:"What does this treasure grant?",rows:3,className:"field-input resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Cost (XP)"}),e.jsx("input",{type:"number",min:1,value:a.point_cost,onChange:s=>B("point_cost",s.target.value),className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Icon (Emoji)"}),e.jsx("input",{type:"text",value:a.icon,onChange:s=>B("icon",s.target.value),placeholder:"e.g. trophy, star, gift",className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Category (Optional)"}),e.jsx("input",{type:"text",value:a.category,onChange:s=>B("category",s.target.value),placeholder:"e.g. Treats, Experiences, Toys",className:"field-input"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-cream text-sm font-medium mb-1 tracking-wide",children:"Stock (Optional)"}),e.jsx("input",{type:"number",min:0,value:a.stock,onChange:s=>B("stock",s.target.value),placeholder:"Leave empty for unlimited",className:"field-input"}),e.jsx("p",{className:"text-muted text-xs mt-1",children:"Leave empty for unlimited supply."})]})]})}),e.jsx(se,{isOpen:!!L,onClose:()=>I(null),title:"Remove Treasure?",actions:[{label:"Keep Treasure",onClick:()=>I(null),className:"game-btn game-btn-blue"},{label:D?"Removing...":"Remove Treasure",onClick:de,className:"game-btn game-btn-red",disabled:D}],children:e.jsxs("p",{className:"text-muted",children:["Are you sure you want to remove"," ",e.jsxs("span",{className:"text-gold font-bold",children:['"',L==null?void 0:L.title,'"']})," ","from the treasure shop? Heroes can no longer redeem this reward."]})})]})}function H({activeTab:i,setTab:x}){return e.jsx("div",{className:"flex gap-1 bg-surface-raised rounded-lg p-1",children:$e.map(({key:o,label:C,icon:h})=>e.jsxs("button",{onClick:()=>x(o),className:`flex-1 flex items-center justify-center gap-1 sm:gap-2 py-2.5 px-1.5 sm:px-3 rounded-md text-xs sm:text-sm font-semibold transition-all ${i===o?"bg-sky/15 text-sky border border-sky/25":"text-muted hover:text-cream border border-transparent"}`,children:[e.jsx(h,{size:16,className:"shrink-0"}),e.jsx("span",{className:"truncate",children:C})]},o))})}export{Ke as default};
