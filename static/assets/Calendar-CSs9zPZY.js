import{a as ie,u as de,r as a,b as y,j as e,k as X,X as ce,g as Y}from"./index-CMujW1nG.js";import{M as le}from"./Modal-9qSkF0BM.js";import{C as me}from"./chevron-left-iD61lFDP.js";import{C as xe}from"./chevron-right-DGEZfmUK.js";import{L as B}from"./loader-circle-Cvei7Ohv.js";import{A as ue,S as he}from"./slash-C4PX2aSK.js";import{C as G}from"./clock-C8kMzf1D.js";import"./index-L_AoP54-.js";import"./proxy-Xgy0M2yx.js";function O(d){return d.toISOString().slice(0,10)}function i(d,m){const c=new Date(d+"T00:00:00");return c.setDate(c.getDate()+m),c.toISOString().slice(0,10)}const be=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function ge(d,m){const c=new Date().toISOString().slice(0,10);return d.status==="verified"?{border:"border-emerald",bg:"bg-emerald/10",icon:e.jsx(Y,{size:16,className:"text-emerald"})}:d.status==="completed"?{border:"border-emerald",bg:"bg-emerald/5",icon:e.jsx(Y,{size:16,className:"text-emerald/60"})}:d.status==="skipped"?{border:"border-border",bg:"bg-navy-light/50",icon:e.jsx(he,{size:16,className:"text-muted"}),textClass:"line-through text-muted"}:m<c?{border:"border-crimson",bg:"bg-crimson/5",icon:e.jsx(G,{size:16,className:"text-crimson"})}:{border:"border-border",bg:"",icon:e.jsx(G,{size:16,className:"text-muted"})}}function Ce(){var H;const d=ie(),{user:m}=de(),c=(m==null?void 0:m.role)==="kid",[r,T]=a.useState(()=>O(new Date)),[L,J]=a.useState({}),[D,$]=a.useState(!0),[_,z]=a.useState(""),[U,f]=a.useState(!1),[u,V]=a.useState(null),[A,K]=a.useState([]),[j,R]=a.useState(""),[I,M]=a.useState(!1),[P,N]=a.useState(""),[q,F]=a.useState(null),h=a.useCallback(async()=>{var t,x,n;$(!0),z("");try{const v=new Date(r+"T00:00:00").getDay(),E=v===0?-6:1-v,g=i(r,E),s=await y(`/api/calendar?week_start=${g}`),l={};for(let o=0;o<7;o++){const p=i(r,o);l[p]=((t=s.days)==null?void 0:t[p])||[]}const w=i(g,7),S=i(r,6),k=i(g,6);if(S>k)try{const o=await y(`/api/calendar?week_start=${w}`);for(let p=0;p<7;p++){const C=i(r,p);!((x=l[C])!=null&&x.length)&&((n=o.days)!=null&&n[C])&&(l[C]=o.days[C])}}catch{}J(l)}catch(b){z(b.message||"Failed to load calendar")}finally{$(!1)}},[r]);a.useEffect(()=>{h()},[h]),a.useEffect(()=>{const t=()=>{h()};return window.addEventListener("ws:message",t),()=>window.removeEventListener("ws:message",t)},[h]);const Z=()=>T(i(r,-7)),ee=()=>T(i(r,7)),te=()=>T(O(new Date)),se=async t=>{V(t),N(""),R(""),f(!0);try{const n=(await y("/api/stats/kids")||[]).filter(b=>b.id!==m.id);K(n)}catch{K([])}},ae=async()=>{if(!j){N("Select a hero to trade with");return}M(!0),N("");try{await y("/api/calendar/trade",{method:"POST",body:{assignment_id:u.id,target_user_id:j}}),f(!1),h()}catch(t){N(t.message||"Trade failed")}finally{M(!1)}},re=async t=>{F(t);try{await y(`/api/calendar/assignments/${t}`,{method:"DELETE"}),h()}catch(x){z(x.message||"Failed to remove quest")}finally{F(null)}},ne=i(r,6),W=O(new Date),oe=r===W,Q=t=>new Date(t+"T00:00:00").toLocaleDateString(void 0,{month:"short",day:"numeric"});return e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{size:28,className:"text-sky"}),e.jsx("h1",{className:"text-cream text-xl font-extrabold leading-relaxed",children:"Quest Calendar"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:Z,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Previous week",children:e.jsx(me,{size:20})}),e.jsxs("span",{className:"text-cream text-sm min-w-[180px] text-center",children:[Q(r)," â€“ ",Q(ne)]}),e.jsx("button",{onClick:ee,className:"p-2 rounded hover:bg-surface-raised transition-colors text-muted hover:text-cream","aria-label":"Next 7 days",children:e.jsx(xe,{size:20})}),!oe&&e.jsx("button",{onClick:te,className:"game-btn game-btn-blue ml-2",children:"Today"})]})]}),_&&e.jsx("div",{className:"mb-4 p-3 rounded border-2 border-crimson/40 bg-crimson/10 text-crimson text-sm text-center",children:_}),D&&e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(B,{size:32,className:"text-sky animate-spin"})}),!D&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-7 gap-3",children:Array.from({length:7},(t,x)=>{const n=i(r,x),b=new Date(n+"T00:00:00"),v=be[b.getDay()],E=n===W,g=L[n]||[];return e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:`text-center py-2 px-1 rounded-t-md border-b-2 ${E?"bg-sky/10 border-sky text-sky":"bg-surface-raised/30 border-border text-muted"}`,children:[e.jsx("div",{className:"text-xs font-bold tracking-wider",children:v}),e.jsx("div",{className:"text-sm mt-1",children:new Date(n+"T00:00:00").getDate()})]}),e.jsxs("div",{className:"space-y-2 mt-2 min-h-[80px]",children:[g.length===0&&e.jsx("p",{className:"text-muted text-xs text-center py-4",children:"No quests"}),g.map(s=>{var w,S,k;const l=ge(s,n);return e.jsxs("div",{className:`game-panel !border-2 ${l.border} ${l.bg} p-2 cursor-pointer hover:brightness-110 transition-all`,onClick:()=>d(`/chores/${s.chore_id||s.id}`),children:[e.jsxs("div",{className:"flex items-start gap-1.5",children:[l.icon,e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-sm leading-tight truncate ${l.textClass||"text-cream"}`,children:((w=s.chore)==null?void 0:w.title)||s.chore_title||"Quest"}),!c&&(((S=s.user)==null?void 0:S.display_name)||s.assigned_to_name)&&e.jsx("p",{className:"text-xs text-purple font-medium mt-0.5 truncate",children:((k=s.user)==null?void 0:k.display_name)||s.assigned_to_name})]})]}),c&&s.status==="pending"&&e.jsxs("button",{onClick:o=>{o.stopPropagation(),se(s)},className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-sky hover:text-sky/80 transition-colors",children:[e.jsx(ue,{size:12}),"Trade"]}),!c&&s.status==="pending"&&e.jsxs("button",{onClick:o=>{o.stopPropagation(),re(s.id)},disabled:q===s.id,className:"mt-1.5 flex items-center gap-1 text-xs font-medium text-crimson hover:text-crimson/80 transition-colors",children:[q===s.id?e.jsx(B,{size:12,className:"animate-spin"}):e.jsx(ce,{size:12}),"Remove"]})]},s.id)})]})]},n)})}),!D&&!_&&Object.values(L).every(t=>t.length===0)&&e.jsxs("div",{className:"text-center py-16",children:[e.jsx(X,{size:48,className:"text-muted mx-auto mb-4"}),e.jsx("p",{className:"text-cream text-lg font-bold",children:"No quests scheduled this week"}),e.jsx("p",{className:"text-muted text-sm mt-2",children:"The quest board is empty. Time to plan new adventures!"})]}),e.jsx(le,{isOpen:U,onClose:()=>f(!1),title:"Propose a Trade",actions:[{label:"Cancel",onClick:()=>f(!1),className:"game-btn game-btn-red"},{label:I?"Sending...":"Send Trade",onClick:ae,className:"game-btn game-btn-blue",disabled:I||!j}],children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-muted text-sm",children:["Trade"," ",e.jsx("span",{className:"text-cream font-bold",children:((H=u==null?void 0:u.chore)==null?void 0:H.title)||(u==null?void 0:u.chore_title)||"Quest"})," ","with another hero:"]}),P&&e.jsx("div",{className:"p-2 rounded border border-crimson/40 bg-crimson/10 text-crimson text-sm",children:P}),A.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No other heroes found in your party."}):e.jsx("div",{className:"space-y-2",children:A.map(t=>e.jsx("button",{onClick:()=>R(t.id),className:`w-full text-left p-3 rounded border-2 transition-colors ${j===t.id?"border-sky bg-sky/10 text-sky":"border-border text-muted hover:border-cream/30"}`,children:e.jsx("span",{className:"text-sm",children:t.display_name||t.username})},t.id))})]})})]})}export{Ce as default};
